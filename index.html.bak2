<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- SEO & META -->
    <title>Chess Tricks | Maestro IA, An√°lisis y Ajedrez Online</title>
    <meta name="description"
        content="Domina el ajedrez con Chess Tricks. Juega contra nuestro Maestro IA, resuelve puzzles t√°cticos y analiza tus partidas con herramientas profesionales.">
    <meta name="keywords"
        content="ajezdrez, chess tricks, maestro ia, puzzles ajedrez, aprender ajedrez, ajedrez online">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Chess Tricks | Maestro IA & Ajedrez Online">
    <meta property="og:description"
        content="La plataforma definitiva para mejorar tu nivel de ajedrez con inteligencia artificial.">
    <meta property="og:image" content="logo.jpg">

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôüÔ∏è</text></svg>">

    <!-- LIBRER√çAS LOCALES (Vendor) -->
    <link rel="stylesheet" href="vendor/chessboard.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00FFD1">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="mobile-nav.css">
    <link rel="stylesheet" href="board_stability.css">
    <link rel="stylesheet" href="academy.css">
    <link rel="stylesheet" href="mobile_tabs.css">
    <link rel="stylesheet" href="auth_styles.css">
</head>

<body>
    <div id="toast-container"></div>
    <div id="mobile-panel-overlay"></div>

    <header class="app-header desktop-only">
        <div class="header-left">
            <div id="hamburger-menu">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </div>
            <div class="logo-area" onclick="goBackToMenu()">
                <img src="logo.jpg" alt="Logo" class="logo-img">
                <span class="logo-text">Chess <span class="accent-text">Drez</span></span>
            </div>
        </div>

        <!-- Navegaci√≥n estilo pesta√±as (Centro) -->
        <nav class="header-center desktop-only" id="main-nav">
            <div class="nav-center-link active" data-section="jugar" onclick="showSubMenu('jugar')">JUGAR</div>
            <div class="nav-center-link" data-section="puzzles" onclick="showSubMenu('puzzles')">T√ÅCTICAS</div>
            <div class="nav-center-link" data-section="academia" onclick="showSubMenu('academy')">ACADEMIA</div>
            <div class="nav-center-link" data-section="aperturas" onclick="showSubMenu('aperturas')">APERTURAS</div>
            <div class="nav-center-link" data-section="analisis" onclick="showSubMenu('analisis')">AN√ÅLISIS</div>
        </nav>

        <!-- Stats y Auth (Derecha) -->
        <div class="header-right">
            <div class="user-stats">
                <!-- Rango oculto si es confuso, solo Elo -->
                <div class="stat-item" style="display:none;">
                    <span class="stat-label">Rango</span>
                    <span class="stat-val" style="color:var(--warning)">Grandmaster</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ELO</span>
                    <span class="stat-val" id="header-elo" style="font-size:1.1rem; color:var(--accent);">500</span>
                </div>
            </div>
            <div id="btn-auth-trigger" class="auth-btn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                Acceder
            </div>
        </div>
    </header>

    <div class="main-layout">
        <!-- SIDEBAR IZQUIERDA -->
        <nav class="sidebar">

            <div class="nav-links">
                <a href="#" class="nav-item active" id="nav-home" onclick="showSubMenu('home')">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg></span>
                    <span class="nav-text">Inicio</span>
                </a>
                <a href="#" class="nav-item" id="nav-jugar" onclick="showSubMenu('jugar')">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M14.5 17.5L3 6V3h3l11.5 11.5M4.5 19.5L19.5 4.5M10 10l.5.5m7.5 7.5L21 21v-3l-11.5-11.5M14 14l-.5-.5" />
                        </svg></span>
                    <span class="nav-text">Jugar</span>
                </a>
                <a href="#" class="nav-item" id="nav-academy" onclick="showSubMenu('academy')">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                            <path d="M6 12v5c3 3 9 3 12 0v-5" />
                        </svg></span>
                    <span class="nav-text">Academia</span>
                </a>
                <div class="nav-item" onclick="showSubMenu('aperturas')" id="nav-aperturas">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                        </svg></span>
                    <span class="nav-text">Aperturas</span>
                </div>
                <a href="#" class="nav-item" id="nav-puzzles" onclick="showSubMenu('puzzles')">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg></span>
                    <span class="nav-text">T√°cticas</span>
                </a>
                <a href="#" class="nav-item" id="nav-historial" onclick="showSubMenu('historial')">
                    <span class="nav-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                        </svg></span>
                    <span class="nav-text">Historial</span>
                </a>
            </div>

            <!-- APERTURAS SELECTOR CONTAINER -->
            <div id="opening-sel-container"
                style="display:none; padding:15px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05);">
                <label
                    style="font-size:0.65rem; color:var(--accent); font-weight:800; display:block; margin-bottom:10px; letter-spacing:1px; text-transform:uppercase;">
                    <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:5px;">
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                    </svg>
                    Apertura
                </label>
                <div class="modern-select-wrapper" style="width:100%;">
                    <select id="opening-sel-main" class="custom-select" style="padding:10px 12px; font-size:0.8rem;">
                        <option value="">-- Elige una apertura... --</option>
                    </select>
                    <div class="select-arrow">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </div>
                </div>
                <select id="opening-sel" style="display:none;"></select>
            </div>

            <div class="sidebar-bottom">
                <!-- Ajustes movidos -->


                <!-- AI GENERATIVA CONFIGURATION (DESACTIVADO TEMPORALMENTE) -->
                <div
                    style="display:none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <label style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M12 11V7a4 4 0 0 1 8 0v4" />
                                <path d="M8 11V7a4 4 0 0 0-8 0v4" />
                                <circle cx="12" cy="18" r="2" />
                                <path d="M8 15h.01" />
                                <path d="M16 15h.01" />
                            </svg>
                            IA GENERATIVA
                        </span>
                        <label class="toggle-switch-small">
                            <input type="checkbox" id="ai-enabled-toggle" onchange="toggleAIExplanations(this.checked)">
                            <span class="slider-small"></span>
                        </label>
                    </label>

                    <div id="ai-config-panel" style="display:none; margin-top:10px;">
                        <label
                            style="font-size:0.65rem; opacity:0.7; margin-bottom:5px; display:block;">PROVEEDOR</label>
                        <div class="modern-select-wrapper" style="width:100%;">
                            <select id="ai-provider-sel" class="custom-select"
                                style="width: 100%; padding-right: 30px;">
                                <option value="openai">OpenAI (Gpt-4o)</option>
                                <option value="anthropic">Anthropic (Claude 3.5)</option>
                                <option value="google">Google (Gemini 1.5)</option>
                            </select>
                            <div class="select-arrow">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9" />
                                </svg>
                            </div>
                        </div>

                        <label style="font-size:0.65rem; opacity:0.7; margin-bottom:5px; display:block;">API
                            KEY</label>
                        <div class="input-container" style="position:relative;">
                            <input type="password" id="ai-api-key-input" placeholder="sk-..."
                                style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:6px; color:#fff; font-size:0.75rem;"
                                onchange="saveAIConfig()">
                            <span class="password-toggle" onclick="togglePasswordVisibility('ai-api-key-input')"
                                style="position:absolute; right:8px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1rem;">üëÅÔ∏è</span>
                        </div>

                        <p style="font-size:0.6rem; opacity:0.6; margin-top:8px; line-height:1.3;">
                            üí° Tu clave se guarda localmente y nunca se comparte.
                            <a href="#" onclick="showAIHelp(); return false;" style="color:var(--accent);">¬øC√≥mo
                                obtener una?</a>
                        </p>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ZONA DE JUEGO (CENTRO) -->
        <main class="game-zone">
            <!-- Men√∫s Emergentes / Submen√∫s -->
            <div id="submenus-container">
                <div class="menu-step active" id="menu-home">
                    <div class="dashboard-container">

                        <!-- SECCIONES SECUNDARIAS (GRID CUADRADO) -->
                        <div class="dash-secondary-grid">
                            <div class="dash-square-card academy dash-module" id="mod-academy"
                                onclick="showSubMenu('academy')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                                        <path d="M6 12v5c3 3 9 3 12 0v-5" />
                                    </svg>
                                </div>
                                <span>Academia</span>
                            </div>
                            <div class="dash-square-card kids dash-module" id="mod-kids"
                                onclick="window.location.href='kids/kids.html'">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon
                                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                    </svg>
                                </div>
                                <span>Zona Ni√±os</span>
                            </div>
                            <div class="dash-square-card settings" onclick="showSubMenu('ajustes')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3" />
                                        <path
                                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                                    </svg>
                                </div>
                                <span>Ajustes</span>
                            </div>
                            <div class="dash-square-card analysis dash-module" id="mod-analysis"
                                onclick="showSubMenu('analisis')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8" />
                                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                    </svg>
                                </div>
                                <span>An√°lisis</span>
                            </div>
                            <div id="btn-profile-dash" class="dash-square-card settings"
                                onclick="showSubMenu('perfil')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                        <circle cx="12" cy="7" r="4" />
                                    </svg>
                                </div>
                                <span id="dash-profile-label">Perfil</span>
                                <span id="dash-profile-status" style="font-size:0.6rem; opacity:0.6;">Invitado</span>
                            </div>
                        </div>

                        <!-- BOTONES PRINCIPALES (RECTANGULARES) -->
                        <div class="dash-main-actions">
                            <button class="dash-big-btn play-rect" onclick="showSubMenu('jugar')">
                                <span class="dash-icon">
                                    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M14.5 17.5L3 6V3h3l11.5 11.5M4.5 19.5L19.5 4.5M10 10l.5.5m7.5 7.5L21 21v-3l-11.5-11.5M14 14l-.5-.5" />
                                    </svg>
                                </span>
                                <div class="dash-btn-text">
                                    <h3>JUGAR AHORA</h3>
                                    <p>Maestro IA o En L√≠nea</p>
                                </div>
                            </button>

                            <button class="dash-big-btn puzzle-rect" id="dash-daily-puz-btn"
                                onclick="window.startDailyPuzzle()">
                                <span class="dash-icon">
                                    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10 9 9 9 8 9"></polyline>
                                    </svg>
                                </span>
                                <div class="dash-btn-text">
                                    <h3 id="dash-daily-puz-title">PROBLEMA DIARIO</h3>
                                    <p id="dash-daily-puz-reward">Gana +25 ELO T√°ctico</p>
                                </div>
                            </button>
                        </div>

                        <div class="quick-stats-row-mobile">
                            <div class="q-stat-item">
                                <span class="q-title">TU ELO</span>
                                <span class="q-value" id="dash-elo-value">500</span>
                            </div>
                            <div class="q-stat-item">
                                <span class="q-title">PUZZLES</span>
                                <span class="q-value" id="dash-puz-value">500üß©</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-root">
                    <!-- Base root menu is now integrated into sidebar, but we keep the logic -->
                </div>

                <div class="menu-step" id="menu-jugar">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Seleccionar Modo</h3>
                    </div>
                    <div class="grid-menu dash-secondary-grid" style="margin-top:20px; padding:0 20px;">
                        <div class="dash-square-card" onclick="showSubMenu('maestro-config')">
                            <div class="dash-card-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                                    <path d="M6 12v5c3 3 9 3 12 0v-5" />
                                </svg>
                            </div>
                            <span>Maestro IA</span>
                        </div>
                        <div class="dash-square-card" onclick="setMode('local')">
                            <div class="dash-card-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M14.5 17.5L3 6V3h3l11.5 11.5M4.5 19.5L19.5 4.5M10 10l.5.5m7.5 7.5L21 21v-3l-11.5-11.5M14 14l-.5-.5" />
                                </svg>
                            </div>
                            <span>Partida Online</span>
                        </div>
                        <div class="dash-square-card" onclick="setMode('pass-and-play')">
                            <div class="dash-card-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                    <circle cx="9" cy="7" r="4" />
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                    <circle cx="19" cy="11" r="4" />
                                </svg>
                            </div>
                            <span>Juego Local</span>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURACI√ìN MAESTRO IA -->
                <div class="menu-step" id="menu-maestro-config">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="showSubMenu('jugar')">‚Üê</button>
                        <h3 class="menu-title">Configurar Partida IA</h3>
                    </div>

                    <div class="config-container">
                        <!-- DIFICULTAD -->
                        <div class="config-group">
                            <div class="config-label-row">
                                <label>NIVEL DE IA</label>
                                <span id="diff-display"
                                    style="color:var(--accent); font-weight:700;">Principiante</span>
                            </div>
                            <div class="difficulty-bar" id="diff-selector">
                                <!-- Generated by JS or static -->
                                <div class="diff-seg" data-lvl="0" onclick="selectDifficulty(0)"></div>
                                <div class="diff-seg" data-lvl="1" onclick="selectDifficulty(1)"></div>
                                <div class="diff-seg" data-lvl="2" onclick="selectDifficulty(2)"></div>
                                <div class="diff-seg" data-lvl="3" onclick="selectDifficulty(3)"></div>
                                <div class="diff-seg" data-lvl="4" onclick="selectDifficulty(4)"></div>
                                <div class="diff-seg" data-lvl="5" onclick="selectDifficulty(5)"></div>
                                <div class="diff-seg" data-lvl="10" onclick="selectDifficulty(10)"></div>
                                <div class="diff-seg" data-lvl="15" onclick="selectDifficulty(15)"></div>
                                <div class="diff-seg" data-lvl="20" onclick="selectDifficulty(20)"></div>
                            </div>
                            <p class="config-desc" id="diff-desc">ELO Aprox: 300</p>
                        </div>

                        <!-- TIEMPO -->
                        <div class="config-group">
                            <label>CONTROL DE TIEMPO</label>
                            <div class="option-row">
                                <button class="btn-option lux-btn" onclick="selectTime('3+2')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:5px;">
                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                                    </svg>
                                    3+2
                                </button>
                                <button class="btn-option active lux-btn" onclick="selectTime('10+0')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:5px;">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    10 min
                                </button>
                                <button class="btn-option lux-btn" onclick="selectTime('30+0')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:5px;">
                                        <circle cx="12" cy="12" r="10" />
                                        <path d="M12 8l-4 8h8l-4-8z" />
                                    </svg>
                                    30 min
                                </button>
                                <button class="btn-option lux-btn" onclick="selectTime('unlimited')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:5px;">
                                        <path
                                            d="M18.178 8c.385-1.215.838-2 1.822-2 1.474 0 2.805 1.154 3.445 3.127 1.019 3.147-2.356 6.873-4.445 6.873-1.022 0-1.457-.681-1.457-1.321 0-.71.551-1.365 1.854-1.365.174 0 .434.01.631.04.032-.016.059-.033.059-.053 0-.365-.733-1.427-1.777-1.427-.64 0-1.304.494-1.304 1.177 0 .996 1.039 2.299 2.508 2.299 1.262 0 2.37-1.245 2.37-2.6 0-1.135-1.353-2.185-3.079-2.253C17.388 10.334 16.333 11.233 15.65 12h-1c-.683-.767-1.738-1.666-3.157-1.327-1.726.068-3.079 1.118-3.079 2.253 0 1.355 1.108 2.6 2.37 2.6 1.469 0 2.508-1.303 2.508-2.299 0-.683-.664-1.177-1.304-1.177-1.044 0-1.777 1.062-1.777 1.427 0 .02.027.037.059.053.197-.03.457-.04.631-.04 1.303 0 1.854.655 1.854 1.365 0 .64-.435 1.321-1.457 1.321-2.089 0-5.464-3.726-4.445-6.873.64-1.973 1.971-3.127 3.445-3.127.984 0 1.437.785 1.822 2" />
                                    </svg>
                                    Sin L√≠mite
                                </button>
                            </div>
                        </div>

                        <!-- COLOR -->
                        <div class="config-group">
                            <label>JUGAR COMO</label>
                            <div class="option-row color-selector">
                                <button class="btn-option active lux-btn" onclick="selectSide('white')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"
                                        style="margin-right:5px; border:1px solid #666; border-radius:50%;">
                                        <circle cx="12" cy="12" r="10" fill="white" />
                                    </svg>
                                    Blancas
                                </button>
                                <button class="btn-option lux-btn" onclick="selectSide('random')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                        style="margin-right:5px;">
                                        <rect x="2" y="2" width="20" height="20" rx="5" ry="5" />
                                        <circle cx="8.5" cy="8.5" r="1.5" />
                                        <circle cx="15.5" cy="8.5" r="1.5" />
                                        <circle cx="8.5" cy="15.5" r="1.5" />
                                        <circle cx="15.5" cy="15.5" r="1.5" />
                                        <circle cx="12" cy="12" r="1.5" />
                                    </svg>
                                    Azar
                                </button>
                                <button class="btn-option lux-btn" onclick="selectSide('black')">
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"
                                        style="margin-right:5px;">
                                        <circle cx="12" cy="12" r="10" fill="black" stroke="white" stroke-width="1" />
                                    </svg>
                                    Negras
                                </button>
                            </div>
                        </div>

                        <button class="btn-action-primary start-game-btn" onclick="launchMaestroGame()">
                            COMENZAR PARTIDA
                        </button>
                    </div>
                </div>

                <div class="menu-step" id="menu-academy">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Academia de Campeones</h3>
                    </div>
                    <div class="academy-container">
                        <div class="academy-hero">
                            <h1 class="academy-title">Academia de Campeones</h1>
                            <p>Convierte tu pasi√≥n en maestr√≠a. De principiante a Gran Maestro.</p>
                            <div id="academy-auth-notice"
                                style="margin-top:20px; color:var(--warning); display:none; align-items:center; gap:8px;">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                    <line x1="12" y1="9" x2="12" y2="13" />
                                    <line x1="12" y1="17" x2="12.01" y2="17" />
                                </svg>
                                Acceso exclusivo para usuarios registrados.
                            </div>
                        </div>

                        <div class="academy-msg-box" id="academy-placement-box" style="display:none;">
                            <h3 style="display:flex; align-items:center; gap:10px;">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10" />
                                    <circle cx="12" cy="12" r="6" />
                                    <circle cx="12" cy="12" r="2" />
                                </svg>
                                ¬øNo sabes por d√≥nde empezar?
                            </h3>
                            <p>Haz nuestra prueba de nivel para saltar las lecciones que ya conoces.</p>
                            <button class="btn-hero-primary" style="margin-top:10px; padding:10px 20px;"
                                onclick="startPlacementTest()">Hacer Prueba de Nivel</button>
                        </div>

                        <div id="academy-lessons-grid" class="academy-grid">
                            <!-- Inyectado por JS -->
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-estudio">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Estudio y Teor√≠a de Aperturas</h3>
                    </div>
                    <div class="grid-menu" style="grid-template-columns: 1fr;"> <!-- Una sola columna para centrar -->
                        <div class="card-option" onclick="showSubMenu('aperturas')">
                            <span class="opt-icon">üìã</span>
                            <h4>M√≥dulo de Aperturas</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Aprende y practica tus l√≠neas favoritas</p>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-analisis">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">An√°lisis</h3>
                    </div>
                    <div class="grid-menu dash-secondary-grid" style="margin-top:20px; padding:0 20px;">
                        <div class="dash-square-card" onclick="setMode('study')">
                            <div class="dash-card-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8" />
                                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                                </svg>
                            </div>
                            <span>An√°lisis Libre</span>
                        </div>
                        <div class="dash-square-card" onclick="showBoardEditor()">
                            <div class="dash-card-icon">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9" />
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />
                                </svg>
                            </div>
                            <span>Editor de Tablero</span>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-aperturas">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="showSubMenu('estudio')">‚Üê</button>
                        <h3 class="menu-title">M√≥dulo de Aperturas</h3>
                    </div>

                    <div class="opening-selection-container"
                        style="padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; max-width: 500px; margin: 0 auto;">

                        <!-- MODO DE ESTUDIO -->
                        <div class="sel-group"
                            style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                            <label class="premium-label">1. Selecciona Modo</label>
                            <div class="pill-toggle" id="opening-mode-toggle">
                                <span class="pill-opt active" data-mode="theory"
                                    onclick="setOpeningMode('theory')">Teor√≠a</span>
                                <span class="pill-opt" data-mode="training"
                                    onclick="setOpeningMode('training')">Entrenar</span>
                                <span class="pill-opt" data-mode="exercises"
                                    onclick="setOpeningMode('exercises')">T√°cticas</span>
                            </div>
                        </div>

                        <!-- SELECCI√ìN DE COLOR (Solo para Entrenamiento) -->
                        <div class="sel-group" id="training-color-group"
                            style="width: 100%; display: none; flex-direction: column; align-items: center;">
                            <label class="premium-label">¬øCon qu√© color quieres jugar?</label>
                            <div class="pill-toggle" id="training-color-toggle">
                                <span class="pill-opt active" data-color="w"
                                    onclick="window.trainingColor='w'; $('#training-color-toggle .pill-opt').removeClass('active'); $(this).addClass('active');">Blancas</span>
                                <span class="pill-opt" data-color="b"
                                    onclick="window.trainingColor='b'; $('#training-color-toggle .pill-opt').removeClass('active'); $(this).addClass('active');">Negras</span>
                                <span class="pill-opt" data-color="r"
                                    onclick="window.trainingColor='r'; $('#training-color-toggle .pill-opt').removeClass('active'); $(this).addClass('active');">Aleatorio</span>
                            </div>
                        </div>

                        <!-- SELECCI√ìN DE APERTURA -->
                        <div class="sel-group" style="width: 100%;">
                            <label class="premium-label" style="text-align: center;">2. Elige tu L√≠nea</label>
                            <div class="modern-select-container">
                                <select id="opening-module-sel" class="lux-select">
                                    <option value="">-- Buscar Apertura o Defensa... --</option>
                                </select>
                            </div>
                        </div>

                        <button id="btn-start-opening" class="btn-hero-primary"
                            style="width: 100%; padding: 18px; margin-top: 10px;"
                            onclick="startOpeningModuleWithCurrentMode()">
                            COMENZAR SESI√ìN
                        </button>

                        <p id="opening-mode-desc"
                            style="font-size: 0.7rem; color: var(--text-dim); text-align: center; opacity: 0.7; line-height: 1.4;">
                            Aprende los conceptos fundamentales y las jugadas principales de la apertura seleccionada.
                        </p>
                    </div>
                </div>

                <div class="menu-step" id="menu-puzzles">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Entrenar T√°cticas</h3>
                    </div>
                    <!-- Configuraci√≥n de Puzzles (Restaurada a formato simple) -->
                    <!-- Configuraci√≥n de Puzzles (Grid Directo) -->
                    <div class="puzzles-config" style="margin-top: 20px;">
                        <label
                            style="font-size: 0.7rem; color: var(--text-dim); font-weight: 800; display: block; margin-bottom: 10px;">
                            RETO ESPECIAL
                        </label>
                        <div id="daily-puzzle-card" class="daily-challenge-card" onclick="window.startDailyPuzzle()">
                            <div class="daily-card-glow"></div>
                            <div class="daily-card-content">
                                <div class="daily-icon">üèÜ</div>
                                <div class="daily-info">
                                    <span class="daily-label">EL RETO DEL MAESTRO</span>
                                    <span class="daily-status" id="daily-puz-status">Disponible para hoy</span>
                                </div>
                                <div class="daily-reward">+25 ELO</div>
                            </div>
                        </div>

                        <label
                            style="font-size: 0.7rem; color: var(--text-dim); font-weight: 800; display: block; margin-top: 25px; margin-bottom: 15px;">
                            ENTRENAMIENTO POR CATEGOR√çAS
                        </label>

                        <div class="grid-menu dash-secondary-grid" id="puz-grid-options" style="padding:0 20px;">
                            <div class="dash-square-card" onclick="selectPuzzleCategory('all')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10 9 9 9 8 9"></polyline>
                                    </svg>
                                </div>
                                <span>Mezclado</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('mate')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg>
                                </div>
                                <span>Mate</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('fork')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                                    </svg>
                                </div>
                                <span>Doble</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('pin')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M12 2a4 4 0 0 1 4 4c0 1.2-.5 2.3-1.4 3.1L12 12l-2.6-2.9C8.5 8.3 8 7.2 8 6a4 4 0 0 1 4-4z" />
                                        <path d="M12 12v10" />
                                        <path d="M9 22h6" />
                                    </svg>
                                </div>
                                <span>Clavada</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('sacrifice')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M12 2l3 7h-6l3-7zM7.5 13c1.5 0 2.5-1 2.5-2.5S9 8 7.5 8 5 9 5 10.5 6 13 7.5 13zM16.5 13c1.5 0 2.5-1 2.5-2.5S18 8 16.5 8 14 9 14 10.5 15 13 16.5 13zM12 22s5-1 5-4.5S14.5 13 12 13s-5 1-5 4.5 5 4.5 5 4.5z" />
                                    </svg>
                                </div>
                                <span>Sacrificio</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('opening')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                    </svg>
                                </div>
                                <span>Apertura</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('middlegame')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <line x1="9" y1="3" x2="9" y2="21" />
                                        <line x1="15" y1="3" x2="15" y2="21" />
                                        <line x1="3" y1="9" x2="21" y2="9" />
                                        <line x1="3" y1="15" x2="21" y2="15" />
                                    </svg>
                                </div>
                                <span>Medio Juego</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('endgame')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                </div>
                                <span>Final</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('hangingPiece')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                                        <path d="M2 17l10 5 10-5" />
                                        <path d="M2 12l10 5 10-5" />
                                        <path d="M12 22V12" stroke-dasharray="2 2" />
                                    </svg>
                                </div>
                                <span>Colgada</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('discoveredAttack')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="3" />
                                        <path
                                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                                    </svg>
                                </div>
                                <span>Descubierta</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('kingsideAttack')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                                        <circle cx="12" cy="11" r="3" />
                                    </svg>
                                </div>
                                <span>F. Rey</span>
                            </div>
                            <div class="dash-square-card" onclick="selectPuzzleCategory('doubleCheck')">
                                <div class="dash-card-icon">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                                        <line x1="12" y1="9" x2="12" y2="13" />
                                        <line x1="12" y1="17" x2="12.01" y2="17" />
                                    </svg>
                                </div>
                                <span>Doble Jaque</span>
                            </div>
                        </div>

                        <!-- Hidden select for compatibility logic -->
                        <select id="puz-cat-sel" style="display:none;">
                            <option value="all">all</option>
                            <option value="mate">mate</option>
                            <option value="fork">fork</option>
                            <option value="pin">pin</option>
                            <option value="sacrifice">sacrifice</option>
                            <option value="opening">opening</option>
                            <option value="middlegame">middlegame</option>
                            <option value="endgame">endgame</option>
                            <option value="hangingPiece">hangingPiece</option>
                            <option value="discoveredAttack">discoveredAttack</option>
                            <option value="kingsideAttack">kingsideAttack</option>
                            <option value="doubleCheck">doubleCheck</option>
                        </select>
                    </div>

                    <!-- Puzzles Statistics & History -->
                    <div class="puzzles-stats-container">
                        <div class="puz-stats-header">
                            <span style="display:flex; align-items:center; gap:8px;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="20" x2="18" y2="10" />
                                    <line x1="12" y1="20" x2="12" y2="4" />
                                    <line x1="6" y1="20" x2="6" y2="14" />
                                </svg>
                                ESTAD√çSTICAS
                            </span>
                            <span id="puz-elo-display"
                                style="color:var(--accent); font-weight:800; display:flex; align-items:center; gap:4px;">
                                500
                                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor"
                                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div id="puz-stats-list" class="puz-stats-grid">
                            <!-- Themes stats will be injected here -->
                        </div>

                        <div class="puz-history-header" style="display:flex; align-items:center; gap:8px;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            √öLTIMOS ACERTADOS
                        </div>
                        <div id="puz-history-list" class="puz-history-list">
                            <!-- History items will be injected here -->
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-historial">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Historial y Estad√≠sticas</h3>
                    </div>

                    <!-- Historial de Partidas -->
                    <div style="padding: 20px;">
                        <h3
                            style="font-size:1.2rem; margin-bottom:15px; color:var(--accent); display:flex; align-items:center; gap:10px;">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <polyline points="12 6 12 12 16 14" />
                            </svg>
                            Historial de Partidas
                        </h3>
                        <div id="game-history-container"
                            style="background:var(--bg-panel); border-radius:12px; padding:15px; border:1px solid var(--border); min-height:200px;">
                            <div
                                style="text-align:center; color:var(--text-dim); padding:40px 20px; border:2px dashed rgba(255,255,255,0.05); border-radius:12px; margin:10px;">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor"
                                    stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                                    style="opacity:0.2; margin-bottom:15px;">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <path d="M12 18V12" />
                                    <path d="M9 15l3-3 3 3" />
                                </svg>
                                <p style="font-weight:600; color:white; opacity:0.8;">Tu historial est√° vac√≠o</p>
                                <p style="font-size:0.75rem; margin-top:8px;">Juega una partida contra el Maestro IA
                                    para comenzar tu registro.</p>
                            </div>
                        </div>

                        <!-- Estad√≠sticas de Puzzles -->
                        <h3 style="font-size:1.2rem; margin:25px 0 15px; color:var(--accent);"><svg viewBox="0 0 24 24"
                                width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round"
                                style="vertical-align:middle; margin-right:8px;">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg> Estad√≠sticas de
                            T√°cticas</h3>
                        <div class="puzzles-stats-container">
                            <div class="puz-stats-header">
                                <span style="display:flex; align-items:center; gap:8px;">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="20" x2="18" y2="10" />
                                        <line x1="12" y1="20" x2="12" y2="4" />
                                        <line x1="6" y1="20" x2="6" y2="14" />
                                    </svg>
                                    ESTAD√çSTICAS
                                </span>
                                <span id="puz-elo-display-main"
                                    style="color:var(--accent); font-weight:800;">500üß©</span>
                            </div>
                            <div id="puz-stats-list-main" class="puz-stats-grid">
                                <!-- Themes stats will be injected here -->
                            </div>

                            <div class="puz-history-header" style="display:flex; align-items:center; gap:8px;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10" />
                                    <polyline points="12 6 12 12 16 14" />
                                </svg>
                                √öLTIMOS ACERTADOS
                            </div>
                            <div id="puz-history-list-main" class="puz-history-list">
                                <!-- History items will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PERFIL -->
                <div class="menu-step" id="menu-perfil">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Mi Perfil</h3>
                    </div>

                    <div style="padding: 20px;">
                        <!-- User Identity -->
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div
                                style="width: 70px; height: 70px; background: var(--accent); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000;">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor"
                                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                    <circle cx="12" cy="7" r="4" />
                                </svg>
                            </div>
                            <h2 id="profile-name-display" style="color: white; margin-bottom: 5px; font-size:1.2rem;">
                                Invitado</h2>
                            <p style="color: var(--accent); font-weight: 700; font-size:0.9rem;">ELO: <span
                                    id="profile-elo-display">500</span></p>
                        </div>

                        <div class="grid-menu dash-secondary-grid" style="margin-top: 20px;">
                            <div class="dash-square-card" onclick="showSubMenu('historial')">
                                <div class="dash-card-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                                    </svg></div>
                                <span>Estad√≠sticas</span>
                            </div>
                            <div class="dash-square-card auth" id="btn-login-perfil"
                                onclick="$('#auth-modal').fadeIn()">
                                <div class="dash-card-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                    </svg></div>
                                <span>Cuentas</span>
                            </div>
                        </div>

                        <button class="btn-secondary" id="btn-logout-perfil"
                            style="margin-top: 30px; width: 100%; display: none; background:rgba(255,107,107,0.1); color:#ff6b6b; border-color:rgba(255,107,107,0.2);"
                            onclick="logout()">CERRAR SESI√ìN</button>
                    </div>
                </div>

                <!-- AJUSTES -->
                <div class="menu-step" id="menu-ajustes">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Ajustes de Aplicaci√≥n</h3>
                    </div>

                    <div style="padding: 20px;">
                        <div class="settings-sections">
                            <!-- Dashboard Customization -->
                            <div class="settings-card">
                                <h4 class="settings-card-title"><svg viewBox="0 0 24 24" width="16" height="16"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <line x1="9" y1="3" x2="9" y2="21" />
                                        <line x1="3" y1="9" x2="21" y2="9" />
                                    </svg> Pantalla de Inicio</h4>
                                <div class="toggle-list">
                                    <label class="toggle-item">
                                        <span>Academia</span>
                                        <input type="checkbox" id="toggle-mod-academy" checked
                                            onchange="updateDashVisibility()">
                                    </label>
                                    <label class="toggle-item">
                                        <span>Zona Ni√±os</span>
                                        <input type="checkbox" id="toggle-mod-kids" checked
                                            onchange="updateDashVisibility()">
                                    </label>
                                    <label class="toggle-item">
                                        <span>An√°lisis</span>
                                        <input type="checkbox" id="toggle-mod-analysis" checked
                                            onchange="updateDashVisibility()">
                                    </label>
                                </div>
                            </div>

                            <!-- Appearance -->
                            <div class="settings-card">
                                <h4 class="settings-card-title"><svg viewBox="0 0 24 24" width="16" height="16"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                                    </svg> Apariencia</h4>
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    <div class="sel-group">
                                        <label style="font-size:0.6rem; color:var(--text-dim);">TEMA TABLERO</label>
                                        <div class="modern-select-wrapper">
                                            <select id="board-theme-sel" class="custom-select">
                                                <option value="classic">Cl√°sico (Azul)</option>
                                                <option value="wood">Madera</option>
                                                <option value="neon">Neon Dark</option>
                                                <option value="forest">Bosque</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="sel-group">
                                        <label style="font-size:0.6rem; color:var(--text-dim);">PIEZAS</label>
                                        <div class="modern-select-wrapper">
                                            <select id="piece-theme-sel" class="custom-select">
                                                <option value="wikipedia">Wikipedia</option>
                                                <option value="alpha">Alpha</option>
                                                <option value="uscf">USCF</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Language -->
                            <div class="settings-card">
                                <h4 class="settings-card-title"><svg viewBox="0 0 24 24" width="16" height="16"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="2" y1="12" x2="22" y2="12" />
                                        <path
                                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                                    </svg> Idioma</h4>
                                <div class="modern-select-wrapper">
                                    <select class="custom-select">
                                        <option value="es">Espa√±ol</option>
                                        <option value="en">English (Pr√≥ximamente)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="board-layout" class="board-wrapper">

                <!-- NAVEGACI√ìN SUPERIOR M√ìVIL (Pesta√±as Unificadas) -->
                <div class="mobile-top-tabs mobile-only">
                    <button class="top-tab-btn left" id="btn-analyze-mobile-tab" onclick="openMobileInfo()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="16" x2="12" y2="12" />
                            <line x1="12" y1="8" x2="12.01" y2="8" />
                        </svg>
                        An√°lisis
                    </button>
                    <button class="top-tab-btn" id="btn-toggle-vista-mobile" onclick="toggleBestMovesGlobal()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                        Mejor Jugada
                    </button>
                    <!-- Maestro AI Button (Repositioned) -->
                    <button class="top-tab-btn" id="btn-maestro-edu" onclick="toggleMaestroEdu()" style="display:none;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
                            <path d="M6 12.5V16a6 6 0 0 0 12 0v-3.5" />
                        </svg>
                        Maestro
                    </button>
                    <button class="top-tab-btn right" id="btn-toggle-ticker" onclick="toggleLogsTicker()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Logs
                    </button>
                </div>

                <!-- PANEL R√ÅPIDO: TOP 3 JUGADAS (Se activa con el bot√≥n Mejor Jugada) -->
                <div id="mobile-best-moves-quick-panel" class="mobile-only"
                    style="display:none; width: 100%; background: rgba(0, 255, 209, 0.1); border-bottom: 1px solid rgba(0, 255, 209, 0.3); padding: 5px 10px; display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 1400;">
                    <span style="font-size: 0.65rem; font-weight: 800; color: var(--accent);">TOP 3:</span>
                    <div id="quick-moves-content"
                        style="display: flex; gap: 8px; flex-wrap: nowrap; overflow-x: auto; scrollbar-width: none;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- TICKER DE LOGS (Una sola l√≠nea, ancho del tablero) -->
                <div id="mobile-logs-ticker-container" class="mobile-logs-ticker mobile-only" style="display:none;">
                    <div class="ticker-wrapper">
                        <div class="logs-bar-content" id="logs-line-ticker">
                            <span class="logs-placeholder">Historial vac√≠o</span>
                        </div>
                    </div>
                </div>



                <div class="player-top">
                    <div class="user-meta">
                        <span id="opp-avatar" class="avatar-circle">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </span>
                        <span id="opp-name">Oponente</span>
                    </div>
                    <div id="opp-timer" class="timer-display">10:00</div>
                </div>

                <div class="drawer-user-card" id="drawer-user-card" onclick="handleProfileClick()"
                    style="display: none;">
                    <div class="drawer-user-avatar">
                        <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Avatar">
                    </div>
                    <div class="drawer-user-info">
                        <span id="drawer-user-name">Invitado</span>
                        <div class="drawer-user-stats">
                            <span id="drawer-user-elo">500 ELO</span> ¬∑ <span id="drawer-puz-elo-display">500üß©</span>
                        </div>
                    </div>
                </div>
                <div class="board-container">
                    <div class="eval-bar-vertical">
                        <div id="eval-fill-master" class="eval-fill"></div>
                    </div>
                    <div class="board-relative">
                        <div id="myBoard"></div>
                        <canvas id="arrowCanvas"></canvas>


                        <div id="maestro-edu-box" class="maestro-edu-box" style="display:none;">
                            <div class="maestro-edu-header">
                                <span>Maestro AI - Comentarios</span>
                                <button onclick="toggleMaestroEdu()" class="btn-close-mini">√ó</button>
                            </div>
                            <div id="maestro-edu-content" class="maestro-edu-content">
                                Selecciona una apertura para comenzar la lecci√≥n.
                            </div>
                        </div>

                        <div id="game-overlay">
                            <h2 id="overlay-msg">JAQUE MATE</h2>
                            <button onclick="$('#game-overlay').fadeOut()" class="btn-close">Continuar</button>
                        </div>
                    </div>
                </div>

                <!-- PERSPECTIVA DEL MAESTRO (HUECO INFERIOR M√ìVIL) -->
                <div id="maestro-perspective-box" class="maestro-edu-box perspective-box" style="display:none;">
                    <div class="maestro-edu-header">
                        <span>Maestro AI - Perspectiva</span>
                        <button onclick="toggleMaestroEdu()" class="btn-close-mini">√ó</button>
                    </div>
                    <div class="maestro-edu-content">
                        <div class="insight-row-mobile">
                            <span class="lbl">Apertura:</span> <span id="maestro-opening-mobile">--</span>
                        </div>
                        <div class="insight-row-mobile">
                            <span class="lbl">Plan:</span> <span id="maestro-plan-mobile">--</span>
                        </div>
                        <div id="maestro-trap-mobile-box" class="trap-alert-mini" style="display:none;">
                            <span class="lbl">‚ö†Ô∏è Trampa:</span> <span id="maestro-trap-mobile">--</span>
                        </div>
                    </div>
                </div>

                <div class="player-bottom">
                    <div class="user-meta">
                        <span id="my-avatar" class="avatar-circle active">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </span>
                        <span id="my-name-display">Invitado</span>
                    </div>
                    <div id="my-timer" class="timer-display">10:00</div>
                </div>

                <div class="nav-controls">
                    <button class="ctrl-btn mobile-only-btn" id="btn-mobile-back" onclick="goBackToMenu()"
                        title="Inicio">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9 22 9 12 15 12 15 22" />
                        </svg>
                    </button>
                    <button class="ctrl-btn" id="btn-nav-first" title="Inicio de partida">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7" />
                            <polyline points="18 17 13 12 18 7" />
                        </svg>
                    </button>
                    <button class="ctrl-btn" id="btn-nav-prev" title="Anterior">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6" />
                        </svg>
                    </button>
                    <button class="ctrl-btn" id="btn-nav-next" title="Siguiente">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6" />
                        </svg>
                    </button>
                    <button class="ctrl-btn" id="btn-nav-last" title="Final de partida">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7" />
                            <polyline points="6 17 11 12 6 7" />
                        </svg>
                    </button>
                    <button class="ctrl-btn" id="btn-flip" title="Girar Tablero">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 4v6h6" />
                            <path d="M23 20v-6h-6" />
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" />
                        </svg>
                    </button>
                </div>

                <!-- CONTROLES DE PUZZLE (REUBICADOS BAJO EL TABLERO) -->
                <div id="puzzle-controls" class="puzzle-controls" style="display:none; margin-top: 15px;">
                    <div class="puz-info-row" style="margin-bottom:10px;">
                        <div id="puz-desc-main" class="puz-description-main">Cargando puzzle...</div>
                        <div id="puz-timer-main" class="puz-timer-main" style="margin-left:auto;">00:00</div>
                    </div>
                    <div class="puz-actions-row">
                        <button class="btn-puzzle-action" onclick="showPuzzleHint()" aria-label="Pista">
                            <span class="icon" aria-hidden="true" style="display:flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18h6" />
                                    <path d="M10 22h4" />
                                    <path
                                        d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7z" />
                                </svg>
                            </span> Pista
                        </button>
                        <button class="btn-puzzle-action danger" onclick="showPuzzleSolution()" aria-label="Soluci√≥n">
                            <span class="icon" aria-hidden="true" style="display:flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                </svg>
                            </span> Soluci√≥n
                        </button>
                        <button class="btn-puzzle-action primary" onclick="loadRandomPuzzle()"
                            aria-label="Siguiente puzzle">
                            Siguiente
                            <span class="icon" aria-hidden="true" style="display:flex;">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                    <polyline points="12 5 19 12 12 19" />
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <!-- MOBILE INFO MODAL -->
        <div id="mobile-info-modal" class="mobile-modal-overlay">
            <div class="mobile-modal-container">
                <div class="mobile-modal-header">
                    <h3>INFO PARTIDA</h3>
                    <button class="btn-close-modal" onclick="closeMobileInfo()">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>

                <!-- CONTENIDO UNIFICADO (Sin pesta√±as, lista vertical) -->
                <div class="mobile-modal-content unified-list">
                    <!-- MAESTRO SECTION -->
                    <div class="info-section">
                        <h4>Perspectiva del Maestro</h4>
                        <div class="maestro-info">
                            <div class="info-row">
                                <span class="info-label">Apertura:</span>
                                <span class="info-value" id="mobile-maestro-opening-modal">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Plan:</span>
                                <span class="info-value" id="mobile-maestro-plan-modal">--</span>
                            </div>
                            <div id="mobile-maestro-trap-box-modal" class="trap-alert" style="display:none;">
                                <span class="info-label">‚ö†Ô∏è Alerta:</span>
                                <span class="info-value warning-text" id="mobile-maestro-trap-modal">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- EVAL SECTION -->
                    <div class="info-section">
                        <h4>An√°lisis T√©cnico</h4>
                        <div class="eval-display">
                            <div class="eval-bar-container">
                                <div class="eval-bar-fill" id="mobile-eval-fill" style="width: 50%;"></div>
                            </div>
                            <div class="eval-stats">
                                <span class="eval-value" id="mobile-eval-text-modal">0.0</span>
                                <span class="eval-depth" id="mobile-depth-modal">Profundidad: --</span>
                            </div>
                        </div>
                    </div>

                    <!-- THREATS SECTION -->
                    <div class="info-section">
                        <h4>Alertas de Peligro</h4>
                        <div id="mobile-threats-list-modal" class="threats-list">Ninguna amenaza detectada</div>
                    </div>

                    <!-- COACH SECTION -->
                    <div class="info-section">
                        <h4>Conversaci√≥n con el Coach</h4>
                        <div id="mobile-coach-logs-modal" class="coach-stable-container"
                            style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; font-size: 0.85rem;">
                            <!-- Sincronizado din√°micamente -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- PANEL LATERAL (DERECHA) - REDISE√ëADO CON SECCIONES COLAPSABLES -->
    </div>

    <!-- MODALES AUTH -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-card auth-card">
            <div class="auth-header">
                <h2 id="auth-title">Bienvenido a Chess Tricks</h2>
                <p id="auth-subtitle">Inicia sesi√≥n para guardar tu progreso</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab-btn active">ENTRAR</button>
                <button class="auth-tab-btn">UNIRSE</button>
            </div>

            <div id="auth-form-content">
                <!-- Social Login Section -->
                <div class="social-auth">
                    <button class="btn-google-auth" onclick="handleGoogleLogin()">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        Continuar con Google
                    </button>
                    <div class="auth-divider">
                        <span>o accede con</span>
                    </div>
                </div>

                <div class="input-group">
                    <label id="label-user">USUARIO O EMAIL</label>
                    <div class="input-container">
                        <i class="input-icon">üë§</i>
                        <input type="text" id="auth-user" placeholder="Nombre o email">
                    </div>
                </div>

                <div class="input-group" id="group-email" style="display:none;">
                    <label>EMAIL</label>
                    <div class="input-container">
                        <i class="input-icon">üìß</i>
                        <input type="email" id="auth-email" placeholder="ejemplo@email.com">
                    </div>
                </div>

                <div class="input-group" id="group-phone" style="display:none;">
                    <label>TEL√âFONO (Opcional)</label>
                    <div class="input-container">
                        <i class="input-icon">üì±</i>
                        <input type="tel" id="auth-phone" placeholder="+34 600 000 000">
                    </div>
                </div>

                <div class="input-group">
                    <label>CONTRASE√ëA</label>
                    <div class="input-container">
                        <i class="input-icon">üîí</i>
                        <input type="password" id="auth-pass" placeholder="******">
                        <span class="password-toggle" onclick="togglePasswordVisibility('auth-pass')">üëÅÔ∏è</span>
                    </div>
                </div>

                <div class="remember-me-container" id="remember-me-row">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size: 0.85rem;">
                        <input type="checkbox" id="auth-remember">
                        Recordarme en este dispositivo
                    </label>
                </div>
            </div>

            <div class="auth-actions">
                <button class="btn-primary-auth" id="btn-auth-submit">ENTRAR AHORA</button>
                <button class="btn-ghost" onclick="$('#auth-modal').fadeOut()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <!-- Duplicate toast-container removed -->

    <!-- MODAL PRUEBA DE NIVEL -->
    <div id="placement-modal" class="placement-modal">
        <div class="placement-card">
            <div id="placement-content">
                <!-- Inyectado por JS -->
            </div>
        </div>
    </div>

    <!-- MOBILE BOTTOM NAVIGATION (REDISE√ëADA CON DUAL FAB) -->
    <nav class="bottom-nav mobile-only-flex">
        <div class="bottom-nav-item active" onclick="goBackToMenu()">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
            </span>
            <span class="nav-label">Inicio</span>
        </div>
        <div class="bottom-nav-item" onclick="showSubMenu('jugar')">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M14.5 17.5L3 6V3h3l11.5 11.5M4.5 19.5L19.5 4.5M10 10l.5.5m7.5 7.5L21 21v-3l-11.5-11.5M14 14l-.5-.5" />
                </svg>
            </span>
            <span class="nav-label">Jugar</span>
        </div>
        <div class="bottom-nav-item" onclick="showSubMenu('puzzles')">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </span>
            <span class="nav-label">Puzzles</span>
        </div>
        <div class="bottom-nav-item" onclick="showSubMenu('aperturas')">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                </svg>
            </span>
            <span class="nav-label">Aperturas</span>
        </div>
        <div class="bottom-nav-item" onclick="showSubMenu('analisis')">
            <span class="nav-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
            </span>
            <span class="nav-label">An√°lisis</span>
        </div>
    </nav>
    <!-- Scripts movidos al final -->
    <!-- MODAL DE INFORME DE PARTIDA -->
    <div id="game-report-modal" class="modal-overlay">
        <div class="modal-card report-card">
            <h2 style="text-align:center; color:var(--accent); margin-bottom:10px;">Resumen de Partida</h2>
            <div class="report-main-stats">
                <div class="report-stat-big">
                    <span id="report-accuracy">0%</span>
                    <label>PRECISI√ìN</label>
                </div>
            </div>
            <div id="report-move-breakdown" class="report-breakdown">
                <!-- Se llena din√°micamente -->
            </div>
            <div class="report-actions">
                <button class="btn-primary-auth" onclick="$('#game-report-modal').fadeOut()">Cerrar</button>
                <button class="btn-secondary" onclick="exportPGN()">Exportar PGN</button>
            </div>
        </div>
    </div>

    <!-- AUDIO PARA TTS (HIDDEN) -->
    <div id="tts-anchor"></div>

    <!-- MODAL EDITOR DE TABLERO -->
    <div id="board-editor-modal" class="modal-overlay">
        <div class="modal-card"
            style="max-width: 500px; touch-action: pan-y !important; -webkit-overflow-scrolling: touch;">
            <div class="menu-header-mobile" style="display:flex; align-items:center; margin-bottom:15px;">
                <button class="btn-back-arrow" onclick="$('#board-editor-modal').fadeOut()"
                    style="background:none; border:none; color:var(--text-secondary); font-size:1.5rem; cursor:pointer; padding:0 10px;">‚Üê</button>
                <h3 class="menu-title" style="margin:0; flex:1; text-align:center; color:var(--accent);">Editor de
                    Posici√≥n</h3>
                <div style="width:40px;"></div>
            </div>

            <!-- TABLERO INTERACTIVO (ARRASTRAR Y SOLTAR) -->
            <div id="editorBoard" style="width:360px; max-width:100%; margin:0 auto 14px;"></div>

            <!-- ACTION BUTTONS (MOVED UP) -->
            <div class="editor-actions"
                style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <button class="btn-secondary" onclick="loadEditorPosition('clear')">Limpiar Tablero</button>
                <button class="btn-secondary" onclick="loadEditorPosition('start')">Posici√≥n Inicial</button>
            </div>
            <button class="btn-secondary" style="width:100%; margin-bottom:10px;"
                onclick="$('#board-editor-modal').fadeOut()">CANCELAR</button>
            <button class="btn-primary-auth" style="width:100%; margin-bottom:20px;"
                onclick="applyEditorPosition()">ANALIZAR ESTA POSICI√ìN</button>

            <hr style="border:0; border-top:1px solid var(--border); margin-bottom:20px; width:100%;">

            <!-- SETTINGS & INPUTS (MOVED DOWN) -->
            <!-- CONTROLES FEN (B√ÅSICOS) -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                <div>
                    <label
                        style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:6px;">TURNO</label>
                    <div class="modern-select-wrapper" style="width:100%;">
                        <select id="editor-turn" class="custom-select" style="width:100%; padding-right:30px;">
                            <option value="w">Blancas</option>
                            <option value="b">Negras</option>
                        </select>
                        <div class="select-arrow">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div>
                    <label
                        style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:6px;">EN
                        PASSANT</label>
                    <div class="input-container" style="margin-bottom:0;">
                        <input type="text" id="editor-ep" placeholder="- o e3" style="text-transform:lowercase;">
                    </div>
                </div>
            </div>

            <label
                style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:6px;">ENROQUE</label>
            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:14px;">
                <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; opacity:0.9;"><input
                        type="checkbox" id="castle-wk"> K</label>
                <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; opacity:0.9;"><input
                        type="checkbox" id="castle-wq"> Q</label>
                <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; opacity:0.9;"><input
                        type="checkbox" id="castle-bk"> k</label>
                <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; opacity:0.9;"><input
                        type="checkbox" id="castle-bq"> q</label>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                <div>
                    <label
                        style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:6px;">HALFMOVE</label>
                    <div class="input-container" style="margin-bottom:0;">
                        <input type="number" id="editor-halfmove" min="0" value="0">
                    </div>
                </div>
                <div>
                    <label
                        style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:6px;">FULLMOVE</label>
                    <div class="input-container" style="margin-bottom:0;">
                        <input type="number" id="editor-fullmove" min="1" value="1">
                    </div>
                </div>
            </div>

            <label
                style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:5px;">IMPORTAR
                FEN</label>
            <div class="input-container" style="margin-bottom:15px;">
                <input type="text" id="editor-fen-input"
                    placeholder="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1">
            </div>

            <label
                style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:5px;">IMPORTAR
                PGN</label>
            <div class="input-container" style="margin-bottom:15px;">
                <textarea id="editor-pgn-input" rows="4" placeholder="1. e4 e5 2. Nf3..."
                    style="resize:none; background:transparent; color:white; width:100%; border:none; outline:none; font-family:inherit;"></textarea>
            </div>

            <button class="btn-secondary" style="width:100%; margin-bottom:10px;" onclick="generateEditorFEN()">GENERAR
                FEN DESDE TABLERO</button>
            <div class="editor-actions"
                style="display:none; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <!-- HIDDEN LEGACY ACTIONS -->
            </div>
            <script src="vendor/jquery.min.js"></script>
            <script src="vendor/chessboard.min.js"></script>
            <script src="vendor/chess.min.js"></script>
            <script src="vendor/socket.io.min.js"></script>
            <script src="academy_data.js"></script>
            <script src="puzzles_data.js"></script>
            <script src="openings_enhanced.js"></script>
            <script src="knowledge_base.js"></script>
            <script src="ai_module.js"></script>
            <script src="auth.js"></script>
            <script src="client.js"></script>
            <script type="module" src="analysisIntegration.js"></script>
</body>

</html>